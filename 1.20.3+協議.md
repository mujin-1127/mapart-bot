# Minecraft 1.20.3+ 資源包協議變更

## 關鍵變更

### 1. 封包名稱變更

**舊版本 (1.20.2 及之前):**
- 接收: `resource_pack_send`
- 回應: `resource_pack_receive`

**新版本 (1.20.3+):**
- 接收: `add_resource_pack`
- 回應: `resource_pack_status`
- 額外: `remove_resource_pack` (移除資源包)

### 2. 封包結構變更

**add_resource_pack 封包內容:**
```json
{
  "uuid": "f8992931-2b02-3289-8756-218fd7e3f71a",
  "url": "https://atlas.nexomc.com/pack.zip?id=xxx",
  "hash": "0d4cd69dfe7f569b173a334361ed1dc5a4dd7ee2",
  "forced": true,
  "promptMessage": {
    "type": "compound",
    "value": {
      "color": {
        "type": "string",
        "value": "#FA4943"
      },
      "text": {
        "type": "string",
        "value": "請使用伺服器材質包，完整體驗遊戲內容。"
      }
    }
  }
}
```

**resource_pack_status 回應格式:**
```javascript
{
  uuid: "資源包的UUID（必須與收到的UUID相同）",
  result: 狀態代碼
}
```

### 3. 狀態代碼

| 代碼 | 名稱 | 說明 |
|------|------|------|
| 0 | successfully_loaded | 成功載入 |
| 1 | declined | 拒絕 |
| 2 | failed_download | 下載失敗 |
| 3 | accepted | 已接受 |
| 4 | downloaded | 已下載 |
| 5 | invalid_url | 無效URL (1.21+) |
| 6 | failed_reload | 重載失敗 (1.21+) |
| 7 | discarded | 已丟棄 (1.21+) |

### 4. 正確的回應順序（針對 Nexo 等插件）

```javascript
// 步驟 1: 發送已接受
bot._client.write('resource_pack_status', {
  uuid: packet.uuid,
  result: 3  // accepted
})

// 步驟 2: 50ms 後發送已下載
setTimeout(() => {
  bot._client.write('resource_pack_status', {
    uuid: packet.uuid,
    result: 4  // downloaded
  })
}, 50)

// 步驟 3: 再 50ms 後發送成功載入
setTimeout(() => {
  bot._client.write('resource_pack_status', {
    uuid: packet.uuid,
    result: 0  // successfully_loaded
  })
}, 100)
```

### 5. Configuration 階段

**1.20.2+ 版本的連接流程:**
1. `connect` → TCP 連接建立
2. `session` → 會話建立
3. `state: login` → 登入狀態
4. **`state: configuration`** ← **資源包在這裡發送！**
5. `spawn` → 進入遊戲

**重要：** 必須在 bot 實例創建後立即註冊資源包監聽器，否則會錯過 configuration 階段的資源包請求。

### 6. 監聽器註冊時機

```javascript
// ✅ 正確：在 bot 實例創建後立即註冊
const bot = mineflayer.createBot(opts)
bot._client.on('add_resource_pack', handleResourcePack)

// ❌ 錯誤：在 login 或 spawn 事件後註冊（太晚了）
bot.once('login', () => {
  bot._client.on('add_resource_pack', handleResourcePack)  // 已經錯過了
})
```

## 實測案例：Nexo 插件

**伺服器:** mcborder.com
**版本:** 1.21.8
**插件:** Nexo (自訂物品材質包)

**觀察到的行為:**
1. 在 `configuration` 階段發送 `add_resource_pack`
2. 資源包為強制 (`forced: true`)
3. 需要完整的三階段回應序列才能通過
4. 如果沒有正確回應，連接會卡在 configuration 階段

## 參考資料

- Minecraft Protocol: https://wiki.vg/Protocol
- Mineflayer 文檔: https://github.com/PrismarineJS/mineflayer
- Configuration Phase (1.20.2+): https://wiki.vg/Protocol#Configuration

---

**文檔創建時間:** 2025
**適用版本:** Minecraft 1.20.3 - 1.21.8+
