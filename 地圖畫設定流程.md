# Mapart Bot 完整設定流程（從零到使用）

本文件說明如何從零開始設定並使用地圖畫（Mapart）機器人，直到能在遊戲內或終端機下指令蓋地圖畫。

---

## 一、前置需求

| 項目 | 說明 |
|------|------|
| **作業系統** | Windows（建議使用 PowerShell） |
| **Node.js** | 18 或以上（[官網下載](https://nodejs.org/)） |
| **Minecraft 帳號** | 支援 Microsoft 登入（裝置代碼授權） |
| **伺服器** | 已確定 IP、埠號、遊戲版本（例如 1.21.11） |

---

## 二、取得專案與安裝依賴

1. **進入專案目錄**（依你的實際路徑）：

   ```powershell
   cd d:\server\git\mineflayer-bot
   ```

2. **安裝依賴**：

   ```powershell
   npm install
   ```

3. **確認檔案結構**：專案根目錄應有 `config.json`（可先複製範例或稍後建立）、`src/main.js`、`package.json`。

---

## 三、設定主設定檔 `config.json`

在專案根目錄建立或編輯 `config.json`，格式如下：

```json
{
  "ip": "你的伺服器位址",
  "port": 25565,
  "version": "1.21.11",
  "username": "你的微軟帳號信箱",
  "auth": "microsoft",
  "language": "zh-tw",
  "whitelist": ["你的遊戲ID", "另一個可下指令的ID"],
  "moneyTransferTarget": ""
}
```

| 欄位 | 必填 | 說明 |
|------|------|------|
| `ip` | ✓ | 伺服器位址（例：`rucat.kynetux.net`） |
| `port` | ✓ | 埠號，多數為 25565 |
| `version` | ✓ | 遊戲版本，須與伺服器一致（例：`1.21.11`） |
| `username` | ✓ | Microsoft 登入時填**微軟帳號信箱**（例：`mujin1127@outlook.com`） |
| `auth` | ✓ | `"microsoft"` 或 `"offline"` |
| `language` | 選填 | 例：`"zh-tw"` |
| `whitelist` | 建議 | 可對 bot **私訊下 mapart 指令**的玩家 ID 陣列 |
| `mapartServer` | 選填 | 若伺服器有 TAB 分流，填分流編號（數字），供 mapart 使用 |
| `moneyTransferTarget` | 選填 | 轉帳目標（與 mapart 無關，可留空） |

**重要**：`username` 在 Microsoft 登入時會用來建立該帳號專用的設定目錄 `config/<username>/`，例如 `config/mujin1127@outlook.com/mapart.json`。

---

## 四、首次啟動與 Microsoft 登入

1. **啟動 Bot**：

   ```powershell
   npm start
   ```

   或：

   ```powershell
   node src/main.js
   ```

2. **完成 Microsoft 登入**：  
   終端會出現類似：

   ```
   [MSA] 請於 https://microsoft.com/link 輸入代碼：XXXX-XXXX，有效期 15 分鐘
   ```

   - 用瀏覽器開啟該網址，輸入代碼並登入 Microsoft 帳號完成授權。
   - 登入成功後，token 會存在**設定檔所在目錄**下的 `.minecraft/`（例如專案根目錄的 `.minecraft/`），之後啟動會自動使用，不需再輸入代碼。

3. **確認進入遊戲**：  
   看到終端出現「bot已成功啟動!」以及「[Mapart] 地圖畫外掛已載入…」即表示 bot 已上線且 mapart 模組就緒。

---

## 五、Mapart 相關設定檔結構

Mapart 會讀取兩類設定：

- **全 Bot 共用**：`config/global/`
- **依帳號（username）**：`config/<你的 username>/`

首次成功進入遊戲後，若檔案不存在，程式會自動建立預設的 `config/global/mapart.json` 與 `config/<username>/mapart.json`。

---

### 5.1 全 Bot 共用：`config/global/mapart.json`

主要設定「投影檔資料夾」與選填的 Discord Webhook：

```json
{
  "schematic_folder": "C:/Users/你的使用者名/AppData/Roaming/PrismLauncher/instances/1.21.11 fabric/minecraft/schematics/",
  "discord_webhookURL": "",
  "replaceMaterials": []
}
```

| 欄位 | 說明 |
|------|------|
| `schematic_folder` | **必改**。放 `.litematic` / `.nbt` 投影檔的資料夾，路徑用 `/` 或 `\\` 皆可，結尾建議加 `/`。 |
| `discord_webhookURL` | 選填。建造完成時要通知的 Discord Webhook URL，不需要可留空 `""`。 |
| `replaceMaterials` | 選填。材料替換規則，進階用，可先保持 `[]`。 |

**請把 `schematic_folder` 改成你電腦上實際放投影檔的資料夾路徑**（例如 Litematica 的 schematics 目錄）。

---

### 5.2 依帳號：`config/<username>/mapart.json`

此檔決定「要蓋哪一個投影、放在哪個座標、用哪個工作站、開圖/命名/分裝」等。範例結構：

```json
{
  "schematic": {
    "filename": "oardefault_0_2.nbt",
    "placementPoint_x": 100032,
    "placementPoint_y": 62,
    "placementPoint_z": 100031
  },
  "materialsMode": "station",
  "station": "station_01.json",
  "open": {
    "folder": "暫時用不到",
    "warp": "繪圖機",
    "height": 9,
    "width": 6,
    "open_start": -1,
    "open_end": -1
  },
  "wrap": {
    "warp": "Example_10",
    "height": 9,
    "width": 6,
    "origin": [0, 0, 0],
    "anvil": [0, 0, 0],
    "anvil_stand": [0, 0, 0],
    "cartography_table": [0, 0, 0],
    "cartography_table_stand": [0, 0, 0],
    "facing": "north",
    "name": "ExampleMP_Name",
    "source": "",
    "artist": "",
    "copy_amount": 1,
    "copy_f_shulker": [0, 0, 0],
    "wrap_input_shulker": [0, 0, 0],
    "wrap_output_shulker": [0, 0, 0],
    "wrap_button": [0, 0, 0]
  }
}
```

你**至少需要正確設定**：

- **`schematic`**：投影檔名與放置點座標（也可用指令 `mapart set` 設定，見下文）。
- **`station`**：工作站設定檔名（對應 `config/global/station_01.json` 等），需與你伺服器上的材料站（地毯等）位置一致。
- **`open`**：開圖用 warp、地圖畫高度/寬度，須與你伺服器開圖區一致。
- **`wrap`**：分裝/命名用 warp、鐵砧/製圖台座標等，若暫不用分裝可先保留預設，之後再改。

---

### 5.3 工作站：`config/global/station_01.json`

`station` 指向的檔案（如 `station_01.json`）描述「材料站」的座標與方塊（例如各色地毯、石頭等），bot 會依此去補料。  
**你必須依伺服器實際蓋好的材料站**，修改 `station_01.json` 內的：

- `stationName`、`stationWarp`
- `offset`（各方向偏移）
- `overfull`、`materials`（每種材料與座標）

若伺服器有現成範例或你已有另一份 station 設定，可複製到 `config/global/` 並在 `mapart.json` 的 `station` 欄位改檔名即可。

---

## 六、投影檔與放置座標

1. **投影檔**  
   - 支援 `.litematic`（Litematica）或 `.nbt`。  
   - 檔案需放在 `config/global/mapart.json` 裡 `schematic_folder` 所設的資料夾中。  
   - 檔名需與設定或指令中使用的名稱一致（含副檔名，例如 `mymap_0_0.nbt`）。

2. **放置點座標**  
   - `placementPoint_x`, `placementPoint_y`, `placementPoint_z` 為「投影左下角」在遊戲世界中的座標。  
   - 程式會檢查：**X 座標須滿足 `(placementPoint_x + 64) % 128 === 0`**（即每 128 格對齊），否則 set 會報錯。

3. **用指令設定投影與座標**（建議）  
   - 在終端或遊戲內私訊（白名單）可下：  
     **`mapart set <檔名> <x> <y> <z>`**  
   - 例：`mapart set mymap_0_0.nbt 100032 62 100031`  
   - 會寫入 `config/<username>/mapart.json` 並檢查檔案是否存在與 X 是否合法。

---

## 七、下指令的方式

### 7.1 終端機（本機）

- 在執行 bot 的 PowerShell 視窗中輸入後按 Enter。  
- **發送到遊戲聊天**：先打一個點再輸入，例如：`.你好`  
- **Mapart 指令**：不用加點，直接打，例如：  
  - `mp info`  
  - `mp set mymap_0_0.nbt 100032 62 100031`  
  - `mp build`  

前綴可用 `mapart`、`mp` 或 `map` 任一。

### 7.2 遊戲內私訊（僅白名單）

- 在遊戲中**私訊給 bot**（格式：`[你的ID -> 我] 指令`）。  
- 只有 `config.json` 的 `whitelist` 裡的玩家可以觸發 mapart 指令。  
- 例：私訊 `mp build`、`map info`。

---

## 八、Mapart 指令一覽

| 指令 | 簡寫 | 說明 |
|------|------|------|
| `mapart set <檔名> <x> <y> <z>` | - | 設定當前要蓋的投影檔與放置點座標 |
| `mapart info` | `mp i` | 查詢目前設定與建造進度 |
| `mapart build` | `mp b` | 開始建造地圖畫（長時間執行） |
| `mapart pause` | `mp p` | 暫停建造 |
| `mapart resume` | `mp r` | 繼續建造 |
| `mapart stop` | `mp s` | 中止建造 |
| `mapart open` | `mp o` | 開圖流程（依 `open` 設定） |
| `mapart name` | `mp n` | 命名流程（依 `wrap` 設定） |
| `mapart copy` | `mp c` | 複印流程 |
| `mapart wrap` | `mp w` | 分裝流程 |

---

## 九、建議操作順序（從零到第一次蓋圖）

1. **環境與專案**  
   - 安裝 Node.js 18+，專案目錄執行 `npm install`。

2. **主設定**  
   - 建立 `config.json`（伺服器、版本、username、auth、whitelist、必要時 mapartServer）。  
   - 首次執行 `npm start`，依終端提示完成 Microsoft 登入。

3. **Mapart 全域設定**  
   - 編輯 `config/global/mapart.json`，將 `schematic_folder` 改為你放投影檔的資料夾路徑。

4. **工作站與地圖畫設定**  
   - 依伺服器實際材料站，編輯或新增 `config/global/station_01.json`（或其它 station 檔）。  
   - 編輯 `config/<username>/mapart.json`，設定正確的 `station`、`open`、`wrap`（座標/warp 依伺服器）；  
   - 或先只設定 `schematic`（檔名與 x,y,z），其餘用預設亦可先試跑。

5. **投影檔**  
   - 將要蓋的 `.litematic` 或 `.nbt` 放到 `schematic_folder`。  
   - 用 **`mp set 檔名 x y z`** 寫入設定（確保 X 滿足 (x+64)%128==0）。

6. **下建造指令**  
   - 終端輸入：`mp build`；或在遊戲內私訊 bot：`mp build`（你需在 whitelist）。  
   - 建造中可用 `mp pause` / `mp resume` / `mp stop` 控制。

7. **後續**  
   - 開圖：`mp open`；命名/複印/分裝：`mp name`、`mp copy`、`mp wrap`（需先依伺服器改好 `open`、`wrap` 座標）。

---

## 十、常見問題

| 問題 | 處理方式 |
|------|----------|
| 找不到設定檔 | 確認 `config.json` 在專案根目錄，或使用 `node src/main.js --config=完整路徑`。 |
| 登入失敗 / 要換帳號 | 刪除專案根目錄下的 `.minecraft/` 後重新啟動，再依提示用新裝置代碼登入。 |
| 未發現投影 | 確認 `config/global/mapart.json` 的 `schematic_folder` 路徑正確，且檔名與 `set` 或設定檔中一致。 |
| X座標可能錯了 | 放置點 X 須滿足 (x+64) 為 128 的倍數，請調整 x 後重新 `mp set`。 |
| Mapart 指令沒反應 | 遊戲內私訊僅白名單有效；終端下指令需等 bot 完全進入遊戲（出現「地圖畫外掛已載入」）。 |
| 材料站 / 開圖 / 分裝座標不對 | 比對伺服器實際建築，修改 `config/global/station_01.json` 與 `config/<username>/mapart.json` 的 `open`、`wrap`。 |

---

## 十一、快速對照

| 想做什麼 | 作法 |
|----------|------|
| 第一次啟動 | `npm install` → 設定 `config.json` → `npm start` → 完成 Microsoft 登入 |
| 指定投影與座標 | 終端或私訊：`mp set 檔名 x y z`（檔案需在 schematic_folder） |
| 開始蓋地圖畫 | 終端或私訊：`mp build` |
| 查進度 | `mp info` |
| 讓某人能私訊下指令 | 將該玩家 ID 加入 `config.json` 的 `whitelist` |
| 換設定檔啟動 | `node src/main.js --config=D:\path\to\config.json` |
| 重設登入狀態 | 刪除 `.minecraft/` 再啟動 |

若需更細的 bot 行為說明（TPA、死亡、終端發言等），請參閱同目錄的 **操作說明.md**。
