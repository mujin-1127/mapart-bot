# Mineflayer Bot 操作說明

本說明描述如何設定、啟動與使用此機器人，以及遊戲內外可用的操作方式。

---

## 一、前置需求

- **作業系統**：Windows（PowerShell）
- **執行方式**：Node.js 18+ 開發執行，或使用 pkg 打包後的 `bot.exe`
- **登入**：支援 Microsoft 裝置代碼登入（終端會顯示驗證網址與代碼）

---

## 二、設定檔 `config.json`

請在執行檔或專案根目錄同層放置 `config.json`，格式如下：

| 欄位 | 說明 |
|------|------|
| `ip` | 伺服器位址 |
| `port` | 埠號（通常 25565） |
| `version` | 遊戲版本（例如 `1.21.11`） |
| `username` | 微軟帳號（Microsoft 登入時）或角色名（離線登入時） |
| `auth` | `"microsoft"` 或 `"offline"` |
| `language` | 選填，例如 `"zh-tw"` |
| `whitelist` | 白名單玩家 ID 陣列，用於 TPA 與私訊指令 |

**設定檔路徑優先順序：**

1. 指令參數：`--config=C:\path\to\config.json`
2. 環境變數：`BOT_CONFIG_PATH=C:\path\to\config.json`
3. 預設：pkg 執行時為執行檔同層的 `config.json`；開發時為專案根目錄或目前工作目錄的 `config.json`

---

## 三、啟動方式

### 開發模式（Node.js）

```powershell
cd d:\server\git\mineflayer-bot
npm install
npm start
```

或直接執行：

```powershell
node src/main.js
```

指定設定檔：

```powershell
node src/main.js --config="D:\path\to\config.json"
```

### 打包後執行（pkg）

```powershell
npm run build
```

將產生的 `dist/bot.exe` 與 `config.json` 放在同一資料夾，雙擊或於該目錄執行：

```powershell
.\bot.exe
```

### 首次 Microsoft 登入

啟動後終端會顯示類似：

```
[MSA] 請於 https://microsoft.com/link 輸入代碼：XXXX-XXXX，有效期 15 分鐘
```

在瀏覽器開啟該網址、輸入代碼完成授權。登入成功後，token 會快取在設定檔所在目錄的 `.minecraft/` 下，之後啟動會自動使用，無需重複輸入代碼。

---

## 四、終端機操作（本機）

- **輸入文字後按 Enter**：該行會以「聊天訊息」送出到遊戲中（等同在遊戲內打字發送）。
- **Ctrl+C**：結束程式（SIGINT）。
- 被踢或斷線時，程式會印出原因，並在約 10 秒後自動重新連線。

---

## 五、遊戲內行為（自動）

| 項目 | 說明 |
|------|------|
| **資源包** | 自動接受伺服器資源包（1.20.2+ configuration 階段）。 |
| **TPA 請求** | 收到「傳送到你」或「你傳送到他」的 TPA 時：白名單內玩家 → 自動 `/tpyes`；否則 `/tpno`。 |
| **死亡** | 死亡後等待約 10 tick 再執行 `/back`（若伺服器有該指令）。 |

白名單格式：`config.json` 的 `whitelist` 可寫 `"ID"` 或 `"ID (備註)"`，程式會自動去掉括號備註再比對。

---

## 六、私訊指令（僅白名單玩家）

只有 **私訊給 bot** 且發送者在 `whitelist` 內時，下列指令才會觸發。

私訊格式為遊戲內對 bot 發送：`[玩家名 -> 我] 指令`，對應的指令為：

| 指令 | 功能 |
|------|------|
| `dropall` | 丟棄背包內所有物品（無保護清單）。 |

若伺服器選單欄位不同，需修改 `src/main.js` 內對應的 `clickWindow` 槽位。

---

## 七、斷線與重連

- 發生 `end`（被踢、逾時、關服等）時，程式會：
  - 關閉 stdin 的 readline
  - 清除每日獎勵與轉帳的計時器（若有排程）
  - 約 **10 秒後** 再次呼叫 `startBot()` 重新連線
- 重連後會重新載入設定與白名單，無需手動重啟程式。

---

## 八、注意事項與故障排查

1. **找不到設定檔**  
   確認 `config.json` 是否在預設路徑，或用 `--config=完整路徑` 指定。

2. **登入失敗 / 要換帳號**  
   刪除設定檔同層的 `.minecraft/` 資料夾後重新啟動，再依終端提示用新裝置代碼登入。

3. **被踢或逾時**  
   查看終端輸出的 `被伺服器踢出:` 或 `連線已中斷:` 訊息；必要時檢查網路與伺服器狀態。

4. **拼字**  
   程式內有 `UncoughtError` 為未修正的拼字（應為 Uncaught），不影響功能。

5. **每日獎勵**  
   目前 **未在程式內排程**（每日領獎未自動啟動）。若需要每日領獎，需在 `startBot` 的 `spawn` 或適當位置自行加入 `setInterval` / `setTimeout` 呼叫。

---

## 九、快速對照

| 想做什麼 | 作法 |
|----------|------|
| 換設定檔 | 使用 `--config=路徑` 或設定 `BOT_CONFIG_PATH` |
| 在遊戲裡代發一句話 | 在終端輸入該句話後 Enter |
| 讓某人能對 bot 下指令 | 將該玩家 ID 加入 `config.json` 的 `whitelist` |
| 關閉程式 | 終端按 Ctrl+C |
| 重設登入狀態 | 刪除 `.minecraft/` 再啟動 |

若需修改自動行為（例如 TPA 規則、選單槽位、重連秒數），請直接編輯 `src/main.js` 對應段落。
